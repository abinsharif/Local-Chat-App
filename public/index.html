<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Local Chat App</title>
  <!-- Bootstrap CSS -->
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
  />
  <style>
    #messages {
      list-style-type: none;
      padding: 0;
      max-height: 300px;
      overflow-y: auto;
    }

    #messages li {
      padding: 5px 10px;
      border-radius: 10px;
      margin-bottom: 5px;
    }

    #messages .own {
      background-color: #d1e7dd;
      text-align: right;
    }

    #messages .other {
      background-color: #f8d7da;
    }

    #chat-container {
      max-width: 600px;
      margin: 50px auto;
    }

    #nickname-section {
      margin-bottom: 20px;
    }

    .nickname {
      font-weight: bold;
    }

    .message-text {
      display: inline-block;
      margin-left: 5px;
    }

    .typing-indicator {
      font-style: italic;
      color: #6c757d;
    }

    /* Add color classes */
    .color-1 { color: #1f77b4; }
    .color-2 { color: #ff7f0e; }
    .color-3 { color: #2ca02c; }
    .color-4 { color: #d62728; }
    .color-5 { color: #9467bd; }
    .color-6 { color: #8c564b; }
    .color-7 { color: #e377c2; }
    .color-8 { color: #7f7f7f; }
    .color-9 { color: #bcbd22; }
    .color-10 { color: #17becf; }
  </style>
</head>
<body>
  <div id="chat-container">
    <h1 class="text-center">Local Chat App</h1>

    <!-- Nickname Section -->
    <div id="nickname-section">
      <form id="nickname-form">
        <div class="input-group mb-3">
          <input
            id="nickname-input"
            class="form-control"
            placeholder="Enter your nickname"
            required
          />
          <button class="btn btn-primary" type="submit">Set Nickname</button>
        </div>
      </form>
    </div>

    <!-- Chat UI -->
    <ul id="messages" class="border mb-3"></ul>
    <div id="typing" class="typing-indicator"></div>
    <form id="chat-form" style="display: none;">
      <div class="input-group">
        <input
          id="message-input"
          autocomplete="off"
          class="form-control"
          placeholder="Type your message here..."
        />
        <button class="btn btn-primary" type="submit">Send</button>
      </div>
    </form>
  </div>

  <!-- Sound Notification -->
  <audio id="message-sound" src="/notification.mp3" preload="auto"></audio>
  <!-- Socket.IO -->
  <script src="/socket.io/socket.io.js"></script>
  <!-- Bootstrap JS Bundle -->
  <script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
  ></script>
  <!-- Client-side JavaScript -->
  <script>
    const socket = io();
    let nickname = '';
    let userColors = {}; // Map to store user colors

    // Handle nickname form submission
    // On form submit, send nickname to server
document.getElementById('nickname-form').addEventListener('submit', (e) => {
    e.preventDefault();
    nickname = document.getElementById('nickname-input').value.trim();
    if (nickname) {
      console.log('Sending nickname to server:', nickname);  // Debugging log
      socket.emit('set nickname', nickname);
      document.getElementById('nickname-section').style.display = 'none';
      document.getElementById('chat-form').style.display = 'block';
    }
  });
  
  // On message submit, send message to server
  document.getElementById('chat-form').addEventListener('submit', (e) => {
    e.preventDefault();
    const input = document.getElementById('message-input');
    const msg = input.value.trim();
    if (msg) {
      console.log('Sending message to server:', msg);  // Debugging log
      socket.emit('chat message', msg);
      input.value = '';
      socket.emit('stop typing'); // Stop typing when message is sent
    }
  });
  

    // Load chat history
    socket.on('load history', (messages) => {
      messages.forEach(({ nickname, msg }) => {
        appendMessage(nickname, msg);
      });
    });

    // Show typing indicator when user is typing
    const messageInput = document.getElementById('message-input');
    messageInput.addEventListener('input', () => {
      socket.emit('typing');
    });

    messageInput.addEventListener('blur', () => {
      socket.emit('stop typing');
    });

    // When a message is received
    socket.on('chat message', ({ nickname: sender, msg }) => {
      appendMessage(sender, msg);
      if (sender !== nickname) {
        playSound();
      }
    });

    // Typing indicator
    socket.on('typing', (user) => {
      document.getElementById('typing').textContent = `${user} is typing...`;
    });

    socket.on('stop typing', () => {
      document.getElementById('typing').textContent = '';
    });

    // Append messages to the list with colors and formatting
    function appendMessage(sender, message) {
      const messages = document.getElementById('messages');
      const item = document.createElement('li');

      // Assign or use existing color for the sender
      if (!userColors[sender]) {
        const colorIndex = Object.keys(userColors).length % 10 + 1;
        userColors[sender] = `color-${colorIndex}`;
      }

      item.innerHTML = `<span class="nickname ${userColors[sender]}">${sender}</span><span class="message-text">${message}</span>`;
      messages.appendChild(item);
      messages.scrollTop = messages.scrollHeight;
    }

    // Play sound when new message is received
    function playSound() {
      const sound = document.getElementById('message-sound');
      sound.play();
    }

    // Request notification permission on page load
    if (Notification.permission !== 'granted') {
      Notification.requestPermission();
    }
  </script>
</body>
</html>
